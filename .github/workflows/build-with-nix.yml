name: Build NixOS Image (GitHub Runners)

on:
  schedule:
    # Build weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  push:
    branches: [main]
    paths:
      - '**.nix'
      - 'cloud-init-99-custom.yaml'
      - '.github/workflows/build-with-nix.yml'
  workflow_dispatch:
    inputs:
      nixos_version:
        description: 'NixOS version (25.11, unstable, etc.)'
        required: false
        default: '25.11'

env:
  NIXOS_VERSION: ${{ github.event.inputs.nixos_version || '25.11' }}

jobs:
  build-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-${{ env.NIXOS_VERSION }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=

      - name: Build NixOS raw disk image
        run: |
          echo "Building NixOS ${{ env.NIXOS_VERSION }} disk image..."

          # Create a flake.nix for building the image
          cat > flake.nix << 'EOF'
          {
            description = "NixOS Hetzner Cloud Image";

            inputs = {
              nixpkgs.url = "github:NixOS/nixpkgs/nixos-${{ env.NIXOS_VERSION }}";
            };

            outputs = { self, nixpkgs }: {
              nixosConfigurations.hetzner = nixpkgs.lib.nixosSystem {
                system = "x86_64-linux";
                modules = [
                  ./configuration.nix
                  {
                    # Build a raw disk image
                    system.build.image = self.nixosConfigurations.hetzner.config.system.build.raw;

                    # Disk image configuration
                    image.format = "raw";
                    image.size = 3072;  # 3GB image size
                  }
                ];
              };
            };
          }
          EOF

          # Build the image
          nix build .#nixosConfigurations.hetzner.config.system.build.raw \
            --print-build-logs

          # The image is at result/nixos.img
          ls -lh result/

      - name: Compress image
        run: |
          echo "Compressing image with xz..."
          xz -9 -v result/nixos.img
          ls -lh result/
          echo "IMAGE_PATH=$(pwd)/result/nixos.img.xz" >> "$GITHUB_ENV"
          echo "IMAGE_SIZE=$(du -h result/nixos.img.xz | cut -f1)" >> "$GITHUB_ENV"

      - name: Install hcloud CLI
        run: |
          wget -q https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz
          tar -xzf hcloud-linux-amd64.tar.gz
          sudo mv hcloud /usr/local/bin/
          hcloud version

      - name: Install hcloud-upload-image
        run: |
          wget -q https://github.com/apricote/hcloud-upload-image/releases/latest/download/hcloud-upload-image-linux-amd64
          chmod +x hcloud-upload-image-linux-amd64
          sudo mv hcloud-upload-image-linux-amd64 /usr/local/bin/hcloud-upload-image

      - name: Upload image to Hetzner Cloud
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          IMAGE_NAME="nixos-${{ env.NIXOS_VERSION }}-netboot-$(date +%Y%m%d-%H%M)"

          echo "Uploading image to Hetzner Cloud..."
          hcloud-upload-image \
            --server-type cx11 \
            --image-path "${{ env.IMAGE_PATH }}" \
            --compression xz \
            --description "$IMAGE_NAME" \
            --labels os=nixos,version=${{ env.NIXOS_VERSION }},type=netboot,created_by=github-actions

          # Get the snapshot ID
          sleep 5
          SNAPSHOT_ID=$(hcloud image list -o json | \
            jq -r '.[] | select(.description == "'"$IMAGE_NAME"'") | .id' | \
            head -1)

          {
            echo "SNAPSHOT_ID=$SNAPSHOT_ID"
            echo "IMAGE_NAME=$IMAGE_NAME"
          } >> "$GITHUB_ENV"

          echo "âœ“ Image uploaded: $SNAPSHOT_ID"

      - name: Test the image
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          echo "Creating test server..."

          SERVER_NAME="test-nixos-$(date +%s)"

          hcloud server create \
            --name "$SERVER_NAME" \
            --type cx11 \
            --image "${{ env.SNAPSHOT_ID }}" \
            --location nbg1 \
            --label purpose=testing \
            --label auto_cleanup=true

          # Wait for boot
          echo "Waiting 60s for boot..."
          sleep 60

          # Get server IP
          SERVER_IP=$(hcloud server describe "$SERVER_NAME" -o json | jq -r '.public_net.ipv4.ip')

          echo "Test server IP: $SERVER_IP"

          # Try to verify (SSH might not be accessible without keys)
          if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@"$SERVER_IP" 'nixos-version' 2>/dev/null; then
            echo "âœ“ NixOS is running!"
          else
            echo "âš  Could not verify via SSH (this is OK if no SSH keys configured)"
          fi

          # Cleanup test server
          echo "Cleaning up test server..."
          hcloud server delete "$SERVER_NAME"

      - name: Cleanup old snapshots
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        run: |
          echo "Cleaning up old snapshots (keeping last 3)..."

          hcloud image list -o json | \
            jq -r '.[] | select(.labels.created_by == "github-actions") | .id' | \
            tail -n +4 | while read -r id; do
              echo "Deleting old snapshot: $id"
              hcloud image delete "$id"
            done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: NixOS ${{ env.NIXOS_VERSION }} - Build #${{ github.run_number }}
          body: |
            ## ðŸŽ‰ NixOS ${{ env.NIXOS_VERSION }} Netboot Image

            **Hetzner Cloud Image ID**: `${{ env.SNAPSHOT_ID }}`
            **Compressed Size**: ${{ env.IMAGE_SIZE }}
            **Build Method**: GitHub Runners (FREE!)
            **Build Time**: ~10 minutes
            **Commit**: ${{ github.sha }}

            ---

            ### ðŸš€ Quick Deploy

            ```bash
            hcloud server create \
              --type cx11 \
              --image ${{ env.SNAPSHOT_ID }} \
              --name my-nixos-server \
              --location nbg1 \
              --ssh-key YOUR_KEY
            ```

            ### ðŸ“‹ What's Inside

            - **NixOS**: ${{ env.NIXOS_VERSION }}
            - **Kernel**: Latest from channel
            - **Packages**: Minimal bootstrap (curl only)
            - **Cloud-init**: Auto-upgrade to latest stable
            - **Swap**: Smart sizing (2-16GB)

            ### ðŸ”§ First Boot

            1. Boots minimal system
            2. Auto-detects latest NixOS stable
            3. Downloads channel from binary cache
            4. Creates swap based on RAM
            5. Ready for `nix-shell -p vim git htop`

            ---

            Built on GitHub runners at no cost! ðŸŽŠ
          draft: false
          prerelease: false

      - name: Update README
        if: github.ref == 'refs/heads/main'
        run: |
          sed -i "s/IMAGE_ID=[0-9]*/IMAGE_ID=${{ env.SNAPSHOT_ID }}/" README.md
          sed -i "s/image = \"[0-9]*\"/image = \"${{ env.SNAPSHOT_ID }}\"/" README.md

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs: update image ID to ${{ env.SNAPSHOT_ID }}" || exit 0
          git push
