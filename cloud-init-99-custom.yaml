#cloud-config

preserve_hostname: false

# Auto-upgrade to latest NixOS stable on first boot
bootcmd:
  # Add latest stable NixOS channel (auto-detect or fallback to 25.11)
  - |
    if [ ! -e /root/.nix-channels ]; then
      # Try to detect latest stable from channels page
      LATEST_STABLE=$(curl -s https://channels.nixos.org/ | grep -oP 'nixos-[0-9]+\.[0-9]+"' | grep -v 'small\|unstable' | head -1 | tr -d '"' || echo 'nixos-25.11')
      echo "Adding NixOS channel: $LATEST_STABLE"
      nix-channel --add https://nixos.org/channels/$LATEST_STABLE nixos
      nix-channel --update
    fi

  # Install SOPS age key if provided via user-data
  - |
    if [ -f /tmp/sops-age-key.txt ]; then
      echo "Installing SOPS age key..."
      mkdir -p /root/.config/sops/age
      chmod 700 /root/.config/sops/age
      mv /tmp/sops-age-key.txt /root/.config/sops/age/keys.txt
      chmod 600 /root/.config/sops/age/keys.txt
      echo "✅ SOPS age key installed - server can now decrypt secrets"
    fi

  # Configure GitHub PAT for private repos if provided
  - |
    if [ -f /tmp/github-pat.txt ]; then
      echo "Configuring GitHub authentication..."
      GITHUB_PAT=$(cat /tmp/github-pat.txt)

      # Configure git to use PAT for HTTPS
      git config --global credential.helper store
      echo "https://${GITHUB_PAT}@github.com" > /root/.git-credentials
      chmod 600 /root/.git-credentials

      # Also set up GitHub CLI if needed
      mkdir -p /root/.config/gh
      cat > /root/.config/gh/hosts.yml <<EOF
    github.com:
        oauth_token: ${GITHUB_PAT}
        user: $(echo $GITHUB_PAT | cut -c1-10)...
        git_protocol: https
    EOF
      chmod 600 /root/.config/gh/hosts.yml

      rm /tmp/github-pat.txt
      echo "✅ GitHub PAT configured - can clone private repos"
    fi

  # Auto-clone repository if specified
  - |
    if [ -f /tmp/repo-url.txt ]; then
      REPO_URL=$(cat /tmp/repo-url.txt)
      CLONE_DIR=$(cat /tmp/repo-dir.txt 2>/dev/null || echo "/root/$(basename $REPO_URL .git)")

      echo "Cloning repository: $REPO_URL"
      git clone "$REPO_URL" "$CLONE_DIR"

      rm /tmp/repo-url.txt
      [ -f /tmp/repo-dir.txt ] && rm /tmp/repo-dir.txt

      echo "✅ Repository cloned to $CLONE_DIR"

      # If it's a NixOS flake, optionally rebuild
      if [ -f /tmp/auto-rebuild.txt ] && [ -f "$CLONE_DIR/flake.nix" ]; then
        echo "Auto-rebuilding NixOS from $CLONE_DIR..."
        cd "$CLONE_DIR"
        FLAKE_NAME=$(cat /tmp/auto-rebuild.txt)
        nixos-rebuild switch --flake ".#${FLAKE_NAME}"
        rm /tmp/auto-rebuild.txt
        echo "✅ NixOS rebuilt from repository"
      fi
    fi

  # Smart swap based on instance RAM
  - |
    if [ ! -f /swapfile ]; then
      RAM_GB=$(free -g | awk "/^Mem:/{print \$2}")
      if [ "$RAM_GB" -le 2 ]; then
        SWAP_SIZE=2
      elif [ "$RAM_GB" -le 8 ]; then
        SWAP_SIZE=$((RAM_GB * 2))
      else
        SWAP_SIZE=16
      fi
      fallocate -l ${SWAP_SIZE}G /swapfile || dd if=/dev/zero of=/swapfile bs=1G count=$SWAP_SIZE
      chmod 600 /swapfile
      mkswap /swapfile
      swapon /swapfile
      grep -q "^/swapfile" /etc/fstab || echo "/swapfile none swap sw 0 0" >> /etc/fstab
      echo "vm.swappiness=10" >> /etc/sysctl.conf
      sysctl -p
    fi
